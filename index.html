
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPI Road to Show Goes to School - Rev. Final UI & Search</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
        <script>
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("selectstart", e => e.preventDefault());
document.addEventListener("keydown", e => {
  if (
    e.key === "F12" ||
    (e.ctrlKey && ["u","U","c","C","x","X","s","S","a","A"].includes(e.key)) ||
    (e.ctrlKey && e.shiftKey && ["I","i","J","j"].includes(e.key))
  ) e.preventDefault();
});
</script>
    <style>
        /* Variabel Warna Merah-Putih-Abu */
        :root {
            --color-primary: #dc3545; /* Merah Utama (Aksi) */
            --color-secondary: #f8f9fa; /* Putih/Terang */
            --color-text: #343a40; /* Abu Tua (Teks) */
            --color-background: #e9ecef; /* Abu Muda (Background Halaman) */
            --color-card-bg: #ffffff; /* Putih (Background Kontainer) */
            --color-accent: #6c757d; /* Abu Sedang (Garis/Border) */
            --color-success: #28a745; /* Hijau (Lulus) */
            --color-danger: #dc3545; /* Merah (Tidak Lulus/Hapus) */
            --color-warning: #ffc107; /* Kuning (Panitia Akses/Ubah) */
            --color-info: #007bff; /* Biru (Tayang) */
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: var(--color-background); 
            color: var(--color-text);
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 20px; 
            background: var(--color-card-bg); 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        
        /* Heading & Pemisah */
        h1 { 
            color: var(--color-primary); 
            border-bottom: 3px solid var(--color-primary); 
            padding-bottom: 10px; 
            margin-bottom: 20px;
            text-align: center;
        }
        
        h2 { 
            color: var(--color-text); 
            border-bottom: 2px solid var(--color-accent); 
            padding-bottom: 8px; 
            margin-top: 25px;
        }
        
        h3, h4 { 
            color: var(--color-primary); 
            margin-top: 15px; 
        }

        hr {
            border: 0;
            height: 1px;
            background-color: var(--color-accent);
            margin: 20px 0;
        }
        
        /* Form Elements */
        input[type="text"], 
        input[type="number"], 
        input[type="password"], 
        select { 
            width: calc(100% - 20px); 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid var(--color-accent); 
            border-radius: 6px;
            box-sizing: border-box; 
        }

        /* Tombol Dasar */
        button { 
            padding: 10px 20px; 
            background-color: var(--color-primary); 
            color: white; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px;
            transition: background-color 0.3s, transform 0.1s; 
            font-weight: bold;
            margin: 5px;
        }
        
        button:hover { 
            background-color: #c82333; 
            transform: translateY(-1px);
        }

        /* Area Tampilan Role */
        .admin-view, .panitia-view, .user-view { 
            display: none; 
            margin-top: 20px; 
            padding: 20px; 
            border: 2px dashed var(--color-primary); 
            border-radius: 8px;
            background-color: var(--color-secondary);
        }

        /* Tab Panitia */
        .panitia-tab-content { 
            display: none; 
            margin-top: 15px; 
            padding: 20px; 
            border: 1px solid var(--color-accent); 
            border-radius: 6px; 
            background-color: #ffffff;
        }

        /* Tombol Tab */
        .tab-button {
            background-color: var(--color-accent);
            color: white;
            padding: 10px 15px;
            margin: 2px;
        }
        .tab-button.active { 
            background-color: var(--color-primary); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .tab-button:hover { 
            background-color: var(--color-primary); 
        }

        /* Tabel Kontainer dan Scroll */
        .table-container {
            max-height: 400px; /* Batasi tinggi tabel untuk vertical scroll */
            overflow-y: auto;
            border: 1px solid var(--color-accent);
            border-radius: 6px;
            margin-top: 10px;
        }
        .data-peserta table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        .data-peserta th, .data-peserta td { 
            border: 1px solid var(--color-accent); 
            padding: 12px 8px; 
            text-align: left; 
            font-size: 0.9em; 
            white-space: nowrap; /* Mencegah konten cell terpotong */
        }
        .data-peserta th {
            background-color: var(--color-accent);
            color: white;
            position: sticky; /* Agar header tetap terlihat saat scroll vertikal */
            top: 0;
            z-index: 10;
        }
        .data-peserta tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Area Pencarian/Filter */
        .search-area {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-area input {
            width: 300px;
            max-width: 100%;
        }

        /* Hasil Kelulusan */
        .result-item { 
            margin-top: 10px; 
            padding: 15px; 
            border-radius: 6px; 
            font-weight: bold; 
            border-left: 5px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lulus { 
            background-color: #d4edda; 
            color: var(--color-success); 
            border-color: var(--color-success); 
        }
        .tidak-lulus { 
            background-color: #f8d7da; 
            color: var(--color-danger); 
            border-color: var(--color-danger); 
        }
        
        /* Tombol Aksi Spesifik */
        .action-button { 
            margin: 4px;
            padding: 8px 12px;
            font-weight: normal;
        }
        
        /* Login Form */
        #login-form { 
            background-color: var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin: 10px auto;
            max-width: 400px;
            border: 1px solid var(--color-accent);
        }
        #login-form input[type="password"] {
            width: 80%;
            margin: 10px 0;
        }
        
        /* Keterangan Status BB/TB */
        .status-ideal { color: var(--color-success); font-weight: bold; }
        .status-kurang, .status-lebih { color: var(--color-danger); font-weight: bold; }
        .status-default { color: var(--color-info); font-weight: normal; }


        /* Responsif untuk Mobile */
        @media (max-width: 768px) {
            .data-peserta th:nth-child(3), .data-peserta td:nth-child(3) { /* Sembunyikan Sekolah di Mobile*/
                display: none;
            }
            .data-peserta td input[type="text"], 
            .data-peserta td input[type="number"] {
                width: 100%;
                margin: 0;
                padding: 5px;
                font-size: 0.8em;
            }
            .action-button {
                padding: 6px 10px;
                font-size: 0.8em;
                display: block;
                width: 90%;
            }
            .result-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            .panitia-view > div:first-of-type {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .tab-button {
                flex: 1 1 30%; 
                min-width: 100px;
                margin: 2px;
            }
            .search-area {
                flex-direction: column;
                align-items: stretch;
            }
            .search-area input {
                width: 100%;
            }

        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üèÜ PPI Road to Show Goes to School</h1>
        
        <div id="mode-selection" style="text-align: center; margin-bottom: 30px;">
            <button onclick="showUserView()" style="background-color: var(--color-info);">
                Akses Peserta (User)
            </button>
            <button onclick="showAdminLogin('admin')" style="background-color: var(--color-danger);">
                Akses Admin
            </button>
            <button onclick="showAdminLogin('panitia')" style="background-color: var(--color-warning); color: var(--color-text);">
                Akses Panitia
            </button>
        </div>

        <div id="login-section" style="display: none;">
            <h2 id="login-title"></h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <input type="hidden" id="role-input">
                <label for="password-input" style="font-weight: bold;">üîë Sandi:</label><br>
                <input type="password" id="password-input" required><br>
                <button type="submit" style="background-color: var(--color-primary);">Login</button>
                <p id="login-error" style="color: var(--color-danger); margin-top: 10px;"></p>
            </form>
            <div style="text-align: center; margin-top: 15px;">
                 <button onclick="location.reload()" style="background-color: var(--color-accent);">Kembali</button>
            </div>
        </div>

        <div id="admin-view" class="admin-view">
            <h2>‚öôÔ∏è Dashboard Admin (Kelola Sekolah, Lulus & Tayang)</h2>
            <div style="text-align: right;"><button onclick="logout()" style="background-color: var(--color-accent);">Logout</button></div>
            
            <hr>

            <div id="sekolahSection">
                <h3>üè´ Kelola Sekolah (Admin Poin 1 & 2)</h3>
                <form id="addSekolahForm" onsubmit="addSekolah(event)" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <input type="text" id="namaSekolah" placeholder="Nama Sekolah Baru" required style="flex-grow: 1; min-width: 150px;">
                    <button type="submit" style="background-color: var(--color-primary); flex-shrink: 0;">Tambah Sekolah</button>
                </form>
                <div id="sekolahList" style="margin-top: 15px;"></div>
            </div>

            <hr>
            
            <div id="dataCleanupSection" style="border: 2px solid var(--color-danger); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3>‚ö†Ô∏è Hapus Semua Data (RISIKO TINGGI)</h3>
                <label>
                    <input type="checkbox" id="confirmDeleteAll"> Saya mengerti, ini akan **menghapus semua data Peserta, Penilaian, dan Sekolah**.
                </label>
                <button onclick="deleteAllData()" style="background-color: var(--color-danger); margin-top: 10px;" disabled id="deleteAllButton">
                    Hapus SEMUA Data
                </button>
            </div>
            <div class="data-peserta">
                <h3>üìù Kelola Status Lulus & Tayang (Admin Poin 3 & 4)</h3>
                <div id="adminPesertaList" class="table-container">Memuat data peserta...</div>
            </div>
        </div>
        
        <div id="panitia-view" class="panitia-view">
            <h2>üìã Dashboard Panitia (Input Data Fisik & Peserta)</h2>
            <div style="text-align: right;"><button onclick="logout()" style="background-color: var(--color-accent);">Logout</button></div>
            
            <hr>

            <div style="text-align: center; margin-bottom: 10px;">
                <button class="tab-button active" onclick="showPanitiaTab('inputPeserta')">Nama Peserta (CRUD)</button>
                <button class="tab-button" onclick="showPanitiaTab('inputBB')">Berat Badan (BB)</button>
                <button class="tab-button" onclick="showPanitiaTab('inputTB')">Tinggi Badan (TB)</button>
            </div>

            <div id="inputPeserta" class="panitia-tab-content" style="display: block;">
                <h3>‚ûï Input Peserta Baru</h3>
                <form id="panitiaInputForm" onsubmit="daftarPesertaHandler(event)">
                    <label for="panitiaSekolahSelect">Pilih Sekolah:</label>
                    <select id="panitiaSekolahSelect" required></select><br>
                    <label for="panitiaNama">Nama Lengkap:</label>
                    <input type="text" id="panitiaNama" required><br>
                    <label for="panitiaJenisKelamin">Jenis Kelamin:</label>
                    <select id="panitiaJenisKelamin" required>
                        <option value="">Pilih</option>
                        <option value="Cewek">Cewek</option>
                        <option value="Cowok">Cowok</option>
                    </select><br>
                    <button type="submit" style="background-color: var(--color-primary);">Daftar Peserta Baru</button>
                </form>
                
                <h4 style="margin-top: 20px;">Daftar & Aksi Peserta</h4>
                <div class="search-area">
                    <input type="text" id="searchCrud" placeholder="Cari Nama atau Kode Peserta..." onkeyup="filterTable('inputPeserta', 'searchCrud', 1, 0)">
                </div>
                <div class="data-peserta table-container" id="panitiaCrudList">Memuat data peserta...</div>
            </div>

            <div id="inputBB" class="panitia-tab-content">
                <h3>‚öñÔ∏è Input/Ubah Berat Badan (BB)</h3>
                <div class="search-area">
                    <input type="text" id="searchBB" placeholder="Cari Nama atau Kode Peserta..." onkeyup="filterTable('inputBB', 'searchBB', 1, 0)">
                </div>
                <div class="data-peserta table-container" id="panitiaBBList"></div>
            </div>

            <div id="inputTB" class="panitia-tab-content">
                <h3>üìè Input/Ubah Tinggi Badan (TB)</h3>
                 <div class="search-area">
                    <input type="text" id="searchTB" placeholder="Cari Nama atau Kode Peserta..." onkeyup="filterTable('inputTB', 'searchTB', 1, 0)">
                </div>
                <div class="data-peserta table-container" id="panitiaTBList"></div>
            </div>

        </div>

        <div id="user-view" class="user-view">
            <h2>üéâ Halaman Peserta (Status Kelulusan)</h2>
            
            <div id="user-spoiler-section" style="background-color: var(--color-secondary); padding: 15px; border-radius: 8px;">
                <h3>üìä Hasil Penilaian (Realtime)</h3>
                <p style="font-size: 1.1em;">Total Keseluruhan Peserta Lulus: <strong id="lulusCount" style="color: var(--color-success); font-size: 1.2em;">0</strong> orang</p>
                <p style="border-top: 1px dashed var(--color-accent); padding-top: 10px;">Status Pendaftar yang **Ditayangkan** Admin:</p>
                <div id="realtimeResults">
                    <p>Menunggu hasil penilaian yang ditayangkan Admin...</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="location.reload()" style="background-color: var(--color-accent);">Kembali ke Pilihan Mode Utama</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // --- KONFIGURASI FIREBASE & INISIALISASI ---
        // =========================================================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDpPEkKbEt6b_v2OWlBfGuaVQpBg2-RWR4",
            authDomain: "cwu-gen-2.firebaseapp.com",
            databaseURL: "https://cwu-gen-2-default-rtdb.firebaseio.com",
            projectId: "cwu-gen-2",
            storageBucket: "cwu-gen-2.appspot.com",
            messagingSenderId: "40585612014",
            appId: "1:40585612014:web:c88141fee3699aca68181ff"
        };
        firebase.initializeApp(FIREBASE_CONFIG);
        const database = firebase.database();
        
        const ADMIN_PASSWORD = "ppiadminku"; 
        const PANITIA_PASSWORD = "ppipanitia"; 
        const USER_ID = "ADM_001"; 

        let allSekolah = {};
        let allPeserta = {}; 
        let allPenilaian = {};
        let allKetentuan = {};
        
        const lastCodeRef = database.ref('metadata/lastCode'); 


        function initializeDataListeners() {
            database.ref('ketentuanLulus').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                     database.ref('ketentuanLulus/Cewek').set({ minBerat: 45, maxBerat: 60, minTinggi: 155, maxTinggi: 170 });
                     database.ref('ketentuanLulus/Cowok').set({ minBerat: 55, maxBerat: 75, minTinggi: 165, maxTinggi: 180 });
                }
            });
            
            database.ref('ketentuanLulus').on('value', (snapshot) => {
                allKetentuan = snapshot.val() || {};
                refreshAdminPanitiaViews(); 
            });

            database.ref('sekolah').on('value', (snapshot) => {
                allSekolah = snapshot.val() || {};
                updateSekolahUI();
                refreshAdminPanitiaViews();
            });

            database.ref('penilaian').on('value', (snapshot) => {
                allPenilaian = snapshot.val() || {};
                updateResultsUI(); 
                refreshAdminPanitiaViews();
            });
            
            database.ref('peserta').on('value', (snapshot) => {
                allPeserta = snapshot.val() || {}; 
                refreshAdminPanitiaViews();
            });
        }
        
        initializeDataListeners();
        
        // Listener untuk Tombol Hapus Semua Data
        document.addEventListener('DOMContentLoaded', () => {
             const confirmCheckbox = document.getElementById('confirmDeleteAll');
             const deleteButton = document.getElementById('deleteAllButton');
             if (confirmCheckbox) {
                 confirmCheckbox.addEventListener('change', () => {
                     if (deleteButton) {
                         deleteButton.disabled = !confirmCheckbox.checked;
                     }
                 });
             }
        });


        function refreshAdminPanitiaViews() {
            if (document.getElementById('admin-view').style.display !== 'none') {
                 renderAdminTable();
            }
            const activeTab = document.querySelector('.panitia-tab-content[style*="block"]');
            if (activeTab) {
                if (activeTab.id === 'inputPeserta') renderPanitiaCrudTable();
                if (activeTab.id === 'inputBB') renderPanitiaBBTable();
                if (activeTab.id === 'inputTB') renderPanitiaTBTable();
            } else if (document.getElementById('panitia-view').style.display !== 'none') {
                 // Render awal saat login panitia
                 renderPanitiaCrudTable();
                 renderPanitiaBBTable();
                 renderPanitiaTBTable();
            }
        }


        // =========================================================================
        // --- KONTROL TAMPILAN & LOGIN ---
        // =========================================================================
        
        // ... (fungsi showUserView, showAdminLogin, handleLogin, logout, showPanitiaTab sama) ...
        function showUserView() {
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-view').style.display = 'none';
            document.getElementById('panitia-view').style.display = 'none';
            document.getElementById('user-view').style.display = 'block';
            updateResultsUI();
        }

        function showAdminLogin(role) {
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('user-view').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('role-input').value = role;
            document.getElementById('login-title').textContent = role === 'admin' ? 'Login Admin' : 'Login Panitia';
            document.getElementById('password-input').value = '';
            document.getElementById('login-error').textContent = '';
        }

        function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password-input').value;
            const role = document.getElementById('role-input').value;
            const errorElement = document.getElementById('login-error');
            
            let correctPassword = role === 'admin' ? ADMIN_PASSWORD : PANITIA_PASSWORD;

            if (password === correctPassword) {
                document.getElementById('login-section').style.display = 'none';
                if (role === 'admin') {
                    document.getElementById('admin-view').style.display = 'block';
                    renderAdminTable();
                } else {
                    document.getElementById('panitia-view').style.display = 'block';
                    updateSekolahDropdowns('panitiaSekolahSelect'); 
                    showPanitiaTab('inputPeserta'); 
                }
                errorElement.textContent = "";
            } else {
                errorElement.textContent = "Sandi salah!";
            }
        }

        function logout() {
            document.getElementById('admin-view').style.display = 'none';
            document.getElementById('panitia-view').style.display = 'none';
            document.getElementById('mode-selection').style.display = 'block';
        }

        function showPanitiaTab(tabId) {
            document.querySelectorAll('.panitia-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`button[onclick="showPanitiaTab('${tabId}')"]`).classList.add('active');
            
            // Render ulang tabel saat tab dibuka
            if (tabId === 'inputPeserta') {
                renderPanitiaCrudTable();
                document.getElementById('searchCrud').value = ''; // Reset search
            }
            if (tabId === 'inputBB') {
                renderPanitiaBBTable();
                document.getElementById('searchBB').value = ''; // Reset search
            }
            if (tabId === 'inputTB') {
                renderPanitiaTBTable();
                document.getElementById('searchTB').value = ''; // Reset search
            }
        }


        // =========================================================================
        // --- LOGIKA UTILITY (Sekolah) & Admin ---
        // =========================================================================

        function updateSekolahDropdowns(dropdownId) {
            const sekolahSelect = document.getElementById(dropdownId);
            if (sekolahSelect) {
                sekolahSelect.innerHTML = '<option value="">Pilih</option>';
                Object.keys(allSekolah).forEach((key) => {
                    const sekolah = allSekolah[key];
                    if (sekolah.statusPenilaian === 'Dibuka') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = sekolah.namaSekolah;
                        sekolahSelect.appendChild(option);
                    }
                });
            }
        }
        
        function updateSekolahUI() {
            const sekolahListDiv = document.getElementById('sekolahList');
            if (sekolahListDiv) {
                sekolahListDiv.innerHTML = '<ul style="list-style-type: none; padding: 0;">';
                Object.keys(allSekolah).forEach((key) => {
                    const sekolah = allSekolah[key];
                    sekolahListDiv.innerHTML += `
                        <li style="padding: 10px; border-bottom: 1px dashed var(--color-accent); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                            <div>${sekolah.namaSekolah} (Status: <strong>${sekolah.statusPenilaian}</strong>)</div>
                            <div>
                                <button class="action-button" style="background-color: ${sekolah.statusPenilaian === 'Dibuka' ? 'var(--color-danger)' : 'var(--color-success)'};" onclick="toggleStatusSekolah('${key}', '${sekolah.statusPenilaian}')">
                                    ${sekolah.statusPenilaian === 'Dibuka' ? 'Tutup' : 'Buka'} Penilaian
                                </button>
                                <button class="action-button delete-btn" onclick="deleteSekolah('${key}', '${sekolah.namaSekolah}')">
                                    Hapus Sekolah
                                </button>
                            </div>
                        </li>
                    `;
                });
                sekolahListDiv.innerHTML += '</ul>';
            }
            updateSekolahDropdowns('panitiaSekolahSelect'); 
        }

        function addSekolah(event) {
            event.preventDefault();
            const namaSekolah = document.getElementById('namaSekolah').value;
            database.ref('sekolah').push({
                namaSekolah: namaSekolah,
                statusPenilaian: 'Dibuka' 
            }).then(() => {
                document.getElementById('namaSekolah').value = '';
                alert('Sekolah berhasil ditambahkan.');
            });
        }

        function toggleStatusSekolah(key, currentStatus) {
            const newStatus = currentStatus === 'Dibuka' ? 'Ditutup' : 'Dibuka';
            database.ref('sekolah/' + key).update({
                statusPenilaian: newStatus
            }).then(() => {
                alert(`Status ${allSekolah[key].namaSekolah} diubah menjadi ${newStatus}.`);
            });
        }
        
        function deleteSekolah(key, namaSekolah) {
             if (confirm(`Apakah Anda yakin ingin menghapus sekolah: ${namaSekolah}? Semua peserta yang terdaftar di sekolah ini TIDAK akan dihapus, tetapi relasi sekolahnya akan hilang.`)) {
                 database.ref('sekolah/' + key).remove().then(() => {
                     alert(`${namaSekolah} berhasil dihapus.`);
                 }).catch(error => {
                     alert("Gagal menghapus sekolah: " + error.message);
                 });
             }
        }
        
        function getPenilaianData(idPeserta) {
             const foundKey = Object.keys(allPenilaian).find(key => allPenilaian[key].idPeserta === idPeserta);
             return foundKey ? { ...allPenilaian[foundKey], idPenilaian: foundKey } : {};
        }
        
        /**
         * ADMIN: Hapus Semua Data
         */
        function deleteAllData() {
             const isChecked = document.getElementById('confirmDeleteAll').checked;
             if (!isChecked) return;
             
             if (confirm("PERINGATAN! Anda akan menghapus SEMUA data peserta, penilaian, dan sekolah secara permanen. Tindakan ini tidak dapat dibatalkan. Lanjutkan?")) {
                 database.ref('peserta').remove();
                 database.ref('penilaian').remove();
                 database.ref('sekolah').remove();
                 // lastCodeRef.remove(); // Opsional: hapus juga metadata
                 
                 alert("SEMUA DATA berhasil dihapus.");
                 document.getElementById('confirmDeleteAll').checked = false;
                 document.getElementById('deleteAllButton').disabled = true;
             }
        }


        /**
         * Render tabel peserta di Admin View (Kelola Status Lulus & Tayang)
         */
        function renderAdminTable() {
            const pesertaListDiv = document.getElementById('adminPesertaList');
            if (!pesertaListDiv) return;
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Kode</th>
                            <th>Nama</th>
                            <th>Sekolah</th>
                            <th>J.Kelamin</th>
                            <th>BB (kg)</th>
                            <th>TB (cm)</th>
                            <th>Keterangan</th>
                            <th>Status Lulus</th>
                            <th>Tayang</th>
                            <th>Aksi Tayang</th>
                        </tr>
                    </thead>
                    <tbody id="adminTbody">
            `;

            for (const idPeserta in allPeserta) {
                const p = allPeserta[idPeserta];
                const penilaianData = getPenilaianData(idPeserta); 
                const sekolahNama = allSekolah[p.idSekolah]?.namaSekolah || 'N/A';
                const currentLulus = penilaianData.hasilLulus;
                const hasilLulusText = currentLulus === true ? 'LULUS' : (currentLulus === false ? 'TIDAK LULUS' : '--');
                const tayangText = penilaianData.statusTayang === true ? 'Ya' : 'Tidak';
                const keterangan = penilaianData.keterangan || '-';
                
                let lulusCell = `<td class="${hasilLulusText === 'LULUS' ? 'lulus' : (hasilLulusText === 'TIDAK LULUS' ? 'tidak-lulus' : '')}" style="font-weight: bold;">${hasilLulusText}</td>`;
                let aksiTayangCell = '<td>Belum Dinilai</td>';


                if (penilaianData.idPenilaian) {
                    lulusCell = `
                        <td>
                            <select onchange="overrideLulusStatus('${penilaianData.idPenilaian}', this.value)" style="width: auto;">
                                <option value="true" ${currentLulus === true ? 'selected' : ''} class="lulus">LULUS</option>
                                <option value="false" ${currentLulus === false ? 'selected' : ''} class="tidak-lulus">TIDAK LULUS</option>
                            </select>
                        </td>
                    `;
                    
                    aksiTayangCell = `
                        <td>
                            <button class="action-button" style="background-color: ${penilaianData.statusTayang ? 'var(--color-danger)' : 'var(--color-info)'};" onclick="toggleTayangHandler('${penilaianData.idPenilaian}', ${!!penilaianData.statusTayang})">
                                ${penilaianData.statusTayang ? 'Stop Tayang' : 'Tayangkan'}
                            </button>
                        </td>
                    `;
                }


                html += `
                    <tr>
                        <td><strong>${p.kodePeserta || '--'}</strong></td>
                        <td>${p.nama}</td>
                        <td>${sekolahNama}</td>
                        <td>${p.jenisKelamin}</td>
                        <td>${penilaianData.beratBadan || '-'}</td>
                        <td>${penilaianData.tinggiBadan || '-'}</td>
                        <td>${keterangan}</td>
                        ${lulusCell}
                        <td>${tayangText}</td>
                        ${aksiTayangCell}
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            pesertaListDiv.innerHTML = html;
        }

        function toggleTayangHandler(idPenilaian, currentStatus) {
            const newStatus = !currentStatus;
            database.ref('penilaian/' + idPenilaian).update({
                statusTayang: newStatus
            }).then(() => {
                alert(`Status tayang diubah menjadi: ${newStatus ? 'Ya' : 'Tidak'}`);
            });
        }
        
        function overrideLulusStatus(idPenilaian, status) {
            let newStatus = null;
            if (status === "true") newStatus = true;
            if (status === "false") newStatus = false;
            
            if (newStatus !== null) {
                database.ref('penilaian/' + idPenilaian).update({
                    hasilLulus: newStatus,
                }).then(() => {
                    alert(`Status kelulusan berhasil diubah secara manual menjadi ${newStatus ? 'LULUS' : 'TIDAK LULUS'}.`);
                });
            } 
        }
        
        // =========================================================================
        // --- FUNGSI KODE ACAK & SEARCH TABLE ---
        // =========================================================================
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const numbers = '0123456789';
            let code = [];
            
            code.push(chars[Math.floor(Math.random() * chars.length)]);
            code.push(chars[Math.floor(Math.random() * chars.length)]);

            code.push(numbers[Math.floor(Math.random() * numbers.length)]);
            code.push(numbers[Math.floor(Math.random() * numbers.length)]);

            for (let i = code.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [code[i], code[j]] = [code[j], code[i]];
            }

            return code.join('');
        }
        
        /**
         * Fungsi untuk filter tabel Panitia berdasarkan Nama atau Kode
         * @param {string} containerId - ID container tab ('inputPeserta', 'inputBB', 'inputTB')
         * @param {string} searchInputId - ID input pencarian
         * @param {number} nameColIndex - Indeks kolom Nama (misal: 1)
         * @param {number} codeColIndex - Indeks kolom Kode (misal: 0)
         */
        function filterTable(containerId, searchInputId, nameColIndex, codeColIndex) {
            const input = document.getElementById(searchInputId);
            const filter = input.value.toUpperCase();
            const tableContainer = document.getElementById(containerId).querySelector('.table-container');
            if (!tableContainer) return;
            
            const tr = tableContainer.getElementsByTagName("tr");
            
            for (let i = 0; i < tr.length; i++) {
                // Skip header row (thead)
                if (tr[i].parentNode.tagName === 'THEAD') continue; 

                const tdName = tr[i].getElementsByTagName("td")[nameColIndex];
                const tdCode = tr[i].getElementsByTagName("td")[codeColIndex];

                if (tdName && tdCode) {
                    let nameText = tdName.textContent || tdName.innerText;
                    let codeText = tdCode.textContent || tdCode.innerText;
                    
                    // Untuk CRUD, Nama ada di dalam input, jadi ambil valuenya
                    if (containerId === 'inputPeserta') {
                        const nameInput = tdName.querySelector('input');
                        if (nameInput) nameText = nameInput.value;
                    }
                    
                    if (nameText.toUpperCase().indexOf(filter) > -1 || codeText.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }


        // =========================================================================
        // --- LOGIKA PANITIA - TAB 1: CRUD NAMA (Dengan Kode Acak 4 Karakter) ---
        // =========================================================================
        
        function daftarPesertaHandler(event) {
            event.preventDefault();
            const idSekolah = document.getElementById('panitiaSekolahSelect').value;
            const nama = document.getElementById('panitiaNama').value;
            const jenisKelamin = document.getElementById('panitiaJenisKelamin').value;

            if (idSekolah && nama && jenisKelamin) {
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Membuat Kode Acak...';

                const tryRegister = async () => {
                    let kodePeserta = generateRandomCode();
                    let isUnique = false;
                    let attempts = 0;

                    while (!isUnique && attempts < 10) { 
                        const exists = Object.values(allPeserta).some(p => p.kodePeserta === kodePeserta);
                        
                        if (!exists) {
                            isUnique = true;
                        } else {
                            kodePeserta = generateRandomCode(); 
                            attempts++;
                        }
                    }

                    if (!isUnique) {
                        alert('Gagal menghasilkan kode unik setelah 10 kali percobaan. Silakan coba lagi.');
                        submitButton.disabled = false;
                        submitButton.textContent = 'Daftar Peserta Baru';
                        return;
                    }

                    database.ref('peserta').push({
                        idSekolah: idSekolah,
                        nama: nama,
                        jenisKelamin: jenisKelamin,
                        kodePeserta: kodePeserta 
                    })
                    .then(() => {
                        alert(`Pendaftaran peserta berhasil! Kode Peserta: ${kodePeserta}`);
                        document.getElementById('panitiaInputForm').reset();
                    })
                    .catch((dbError) => {
                        alert('Gagal menyimpan data peserta: ' + dbError.message);
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Daftar Peserta Baru';
                    });
                };

                tryRegister();

            } else {
                alert('Semua kolom harus diisi.');
            }
        }
        
        function renderPanitiaCrudTable() {
            const pesertaListDiv = document.getElementById('panitiaCrudList');
            if (!pesertaListDiv) return;
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Kode</th>
                            <th>Nama</th>
                            <th>Sekolah</th>
                            <th>J.Kelamin</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const idPeserta in allPeserta) {
                const p = allPeserta[idPeserta];
                const sekolahNama = allSekolah[p.idSekolah]?.namaSekolah || 'N/A';

                html += `
                    <tr>
                        <td><strong>${p.kodePeserta || '--'}</strong></td>
                        <td><input type="text" id="nama-input-${idPeserta}" value="${p.nama}" size="15" style="width: 150px;"></td>
                        <td>${sekolahNama}</td>
                        <td>${p.jenisKelamin}</td>
                        <td>
                            <button class="update-btn action-button" onclick="ubahPesertaNama('${idPeserta}')">Ubah Nama</button>
                            <button class="delete-btn action-button" onclick="hapusPeserta('${idPeserta}')">Hapus</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            pesertaListDiv.innerHTML = html;
            filterTable('inputPeserta', 'searchCrud', 1, 0); // Terapkan filter saat render
        }

        function ubahPesertaNama(idPeserta) {
            const newName = document.getElementById(`nama-input-${idPeserta}`).value;
            if (!newName) {
                alert('Nama tidak boleh kosong.');
                return;
            }
            database.ref('peserta/' + idPeserta).update({
                nama: newName
            }).then(() => {
                alert('Nama peserta berhasil diubah.');
            });
        }

        function hapusPeserta(idPeserta) {
            if (confirm('Yakin ingin menghapus peserta ini? Semua data penilaian juga akan hilang.')) {
                database.ref('peserta/' + idPeserta).remove().then(() => {
                    const penilaianKeys = Object.keys(allPenilaian).filter(key => allPenilaian[key].idPeserta === idPeserta);
                    penilaianKeys.forEach(key => database.ref('penilaian/' + key).remove());
                    alert('Peserta dan penilaian terkait berhasil dihapus.');
                });
            }
        }
        
        function getStatusKeterangan(nilai, min, max, unit) {
            let statusClass = 'status-default';
            let keterangan = 'Belum Dinilai';

            if (nilai) {
                if (nilai >= min && nilai <= max) {
                    keterangan = 'IDEAL';
                    statusClass = 'status-ideal';
                } else if (nilai < min) {
                    keterangan = `KURANG (Min ${min} ${unit})`;
                    statusClass = 'status-kurang';
                } else {
                    keterangan = `LEBIH (Max ${max} ${unit})`;
                    statusClass = 'status-lebih';
                }
            } else {
                 keterangan = 'Masukkan nilai';
            }
            return `<span class="${statusClass}">${keterangan}</span>`;
        }


        // =========================================================================
        // --- LOGIKA PANITIA - TAB 2: INPUT BB (Dengan Keterangan) ---
        // =========================================================================

        function renderPanitiaBBTable() {
            const pesertaListDiv = document.getElementById('panitiaBBList');
            if (!pesertaListDiv) return;
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Kode</th>
                            <th>Nama</th>
                            <th>Sekolah</th>
                            <th>J.Kelamin</th>
                            <th>Input BB (kg)</th>
                            <th>Status BB</th>
                            <th>Keterangan (Opsional)</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const idPeserta in allPeserta) {
                const p = allPeserta[idPeserta];
                const penilaianData = getPenilaianData(idPeserta); 
                const sekolahNama = allSekolah[p.idSekolah]?.namaSekolah || 'N/A';
                
                const kriteria = allKetentuan[p.jenisKelamin] || {};
                const bbMin = kriteria.minBerat || 0;
                const bbMax = kriteria.maxBerat || 0;
                
                const statusKeterangan = getStatusKeterangan(penilaianData.beratBadan, bbMin, bbMax, 'kg');


                html += `
                    <tr>
                        <td><strong>${p.kodePeserta || '--'}</strong></td>
                        <td>${p.nama}</td>
                        <td>${sekolahNama}</td>
                        <td>${p.jenisKelamin}</td>
                        <td>
                            <input type="number" step="0.1" id="bb-input-${idPeserta}" placeholder="Berat" value="${penilaianData.beratBadan || ''}" style="width: 80px; display: inline-block;">
                        </td>
                        <td>${statusKeterangan}</td>
                        <td>
                             <input type="text" id="keterangan-bb-${idPeserta}" placeholder="Cth: Sakit / Normal" value="${penilaianData.keterangan || ''}" style="width: 150px; display: inline-block;">
                        </td>
                        <td>
                            <button class="action-button" style="background-color: var(--color-info);" onclick="inputNilaiBB('${idPeserta}')">Input/Ubah</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            pesertaListDiv.innerHTML = html;
            filterTable('inputBB', 'searchBB', 1, 0); // Terapkan filter saat render
        }

        function inputNilaiBB(idPeserta) {
            const berat = parseFloat(document.getElementById(`bb-input-${idPeserta}`).value);
            const keterangan = document.getElementById(`keterangan-bb-${idPeserta}`).value;
            const peserta = allPeserta[idPeserta];
            const existingPenilaian = getPenilaianData(idPeserta);
            
            if (isNaN(berat) || berat <= 0) {
                alert('Berat Badan harus diisi dengan angka positif.');
                return;
            }

            const tinggi = existingPenilaian.tinggiBadan;
            const existingIdPenilaian = existingPenilaian.idPenilaian;

            let hasilLulus = false;
            const kriteria = allKetentuan[peserta.jenisKelamin];
            
            if (kriteria && berat >= kriteria.minBerat && berat <= kriteria.maxBerat) {
                 if (tinggi && tinggi >= kriteria.minTinggi && tinggi <= kriteria.maxTinggi) {
                     hasilLulus = true;
                 } else {
                     hasilLulus = false;
                 }
            } else {
                 hasilLulus = false;
            }
            
            // Simpan atau Update data
            saveOrUpdatePenilaian(idPeserta, berat, tinggi, hasilLulus, existingIdPenilaian, 'BB', keterangan);
        }


        // =========================================================================
        // --- LOGIKA PANITIA - TAB 3: INPUT TB (Dengan Keterangan) ---
        // =========================================================================

        function renderPanitiaTBTable() {
            const pesertaListDiv = document.getElementById('panitiaTBList');
            if (!pesertaListDiv) return;
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Kode</th>
                            <th>Nama</th>
                            <th>Sekolah</th>
                            <th>J.Kelamin</th>
                            <th>Input TB (cm)</th>
                            <th>Status TB</th>
                            <th>Keterangan (Opsional)</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const idPeserta in allPeserta) {
                const p = allPeserta[idPeserta];
                const penilaianData = getPenilaianData(idPeserta); 
                const sekolahNama = allSekolah[p.idSekolah]?.namaSekolah || 'N/A';

                const kriteria = allKetentuan[p.jenisKelamin] || {};
                const tbMin = kriteria.minTinggi || 0;
                const tbMax = kriteria.maxTinggi || 0;
                
                const statusKeterangan = getStatusKeterangan(penilaianData.tinggiBadan, tbMin, tbMax, 'cm');

                html += `
                    <tr>
                        <td><strong>${p.kodePeserta || '--'}</strong></td>
                        <td>${p.nama}</td>
                        <td>${sekolahNama}</td>
                        <td>${p.jenisKelamin}</td>
                        <td>
                            <input type="number" step="0.1" id="tb-input-${idPeserta}" placeholder="Tinggi" value="${penilaianData.tinggiBadan || ''}" style="width: 80px; display: inline-block;">
                        </td>
                        <td>${statusKeterangan}</td>
                        <td>
                            <input type="text" id="keterangan-tb-${idPeserta}" placeholder="Cth: Postur Tegak" value="${penilaianData.keterangan || ''}" style="width: 150px; display: inline-block;">
                        </td>
                        <td>
                            <button class="action-button" style="background-color: var(--color-info);" onclick="inputNilaiTB('${idPeserta}')">Input/Ubah</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            pesertaListDiv.innerHTML = html;
            filterTable('inputTB', 'searchTB', 1, 0); // Terapkan filter saat render
        }

        function inputNilaiTB(idPeserta) {
            const tinggi = parseFloat(document.getElementById(`tb-input-${idPeserta}`).value);
            const keterangan = document.getElementById(`keterangan-tb-${idPeserta}`).value;
            const peserta = allPeserta[idPeserta];
            const existingPenilaian = getPenilaianData(idPeserta);
            
            if (isNaN(tinggi) || tinggi <= 0) {
                alert('Tinggi Badan harus diisi dengan angka positif.');
                return;
            }

            const berat = existingPenilaian.beratBadan;
            const existingIdPenilaian = existingPenilaian.idPenilaian;

            let hasilLulus = false;
            const kriteria = allKetentuan[peserta.jenisKelamin];
            
            if (kriteria && tinggi >= kriteria.minTinggi && tinggi <= kriteria.maxTinggi) {
                 if (berat && berat >= kriteria.minBerat && berat <= kriteria.maxBerat) {
                     hasilLulus = true;
                 } else {
                     hasilLulus = false;
                 }
            } else {
                 hasilLulus = false;
            }

            // Simpan atau Update data
            saveOrUpdatePenilaian(idPeserta, berat, tinggi, hasilLulus, existingIdPenilaian, 'TB', keterangan);
        }


        // =========================================================================
        // --- LOGIKA UTILITY PENILAIAN ---
        // =========================================================================

        function saveOrUpdatePenilaian(idPeserta, berat, tinggi, hasilLulus, existingIdPenilaian, mode, keterangan) {
            const existingStatusTayang = existingIdPenilaian ? allPenilaian[existingIdPenilaian].statusTayang : false;

            const dataToSave = {
                idPeserta: idPeserta,
                idAdmin: USER_ID, 
                tglPenilaian: new Date().toISOString(),
                beratBadan: berat || null, 
                tinggiBadan: tinggi || null, 
                hasilLulus: hasilLulus,
                statusTayang: existingStatusTayang,
                keterangan: keterangan || null // Tambahkan keterangan
            };
            
            let statusAlert = (berat && tinggi) ? 
                ('Status kelulusan: ' + (hasilLulus ? 'LULUS' : 'TIDAK LULUS')) : 
                'Kelulusan akan dihitung setelah BB dan TB terisi.';

            if (existingIdPenilaian) {
                // UPDATE
                database.ref('penilaian/' + existingIdPenilaian).update(dataToSave).then(() => {
                    alert(`Nilai ${mode} dan Keterangan berhasil diubah. ${statusAlert}`);
                });
            } else {
                // INPUT BARU
                const newPenilaianRef = database.ref('penilaian').push();
                newPenilaianRef.set(dataToSave).then(() => {
                    alert(`Nilai ${mode} berhasil disimpan. ${statusAlert}`);
                });
            }
        }


        // =========================================================================
        // --- LOGIKA USER (Lihat Status) ---
        // =========================================================================

        function updateResultsUI() {
            const realtimeResults = document.getElementById('realtimeResults');
            const lulusCountElement = document.getElementById('lulusCount');
            if (!realtimeResults || !lulusCountElement) return;

            realtimeResults.innerHTML = '';
            let totalLulus = 0;

            
            Object.keys(allPenilaian).forEach(key => {
                const data = allPenilaian[key];
                
                // Display Realtime yang Ditayangkan
                if (data.statusTayang === true) {
                    const peserta = allPeserta[data.idPeserta];
                    if (peserta) {
                        const div = document.createElement('div');
                        const statusClass = data.hasilLulus ? 'lulus' : 'tidak-lulus';
                        const statusText = data.hasilLulus ? 'LULUS' : 'TIDAK LULUS';
                        const sekolahNama = allSekolah[peserta.idSekolah]?.namaSekolah || 'N/A';
                        const kode = peserta.kodePeserta || 'N/A';
                        const keterangan = data.keterangan ? `(Ket: ${data.keterangan})` : '';

                        div.className = 'result-item ' + statusClass;
                        div.innerHTML = `
                            <div>
                                <strong>[${kode}] ${peserta.nama}</strong> 
                                <span style="font-size: 0.9em; color: var(--color-text);">(${sekolahNama} - ${peserta.jenisKelamin})</span>
                                <span style="display: block; font-size: 0.8em; font-weight: normal; color: #555;">${keterangan}</span>
                            </div>
                            <span style="font-size: 1.1em;">Status: ${statusText}</span>
                        `;
                        realtimeResults.appendChild(div);
                    }
                }
                
                // Hitung total lulus 
                if (data.hasilLulus === true) {
                    totalLulus++;
                }
            });

            lulusCountElement.textContent = totalLulus;

            if (realtimeResults.innerHTML === '') {
                realtimeResults.innerHTML = '<p>Belum ada hasil penilaian yang ditayangkan.</p>';
            }
        }
    </script>
</body>
</html>
