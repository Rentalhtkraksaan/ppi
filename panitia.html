<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPI Road to Show Goes to School - Dashboard Panitia</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        document.addEventListener("contextmenu", e => e.preventDefault());
        document.addEventListener("selectstart", e => e.preventDefault());
        document.addEventListener("keydown", e => {
            if (e.key === "F12" || (e.ctrlKey && ["u","U","c","C","x","X","s","S","a","A"].includes(e.key)) || (e.ctrlKey && e.shiftKey && ["I","i","J","j"].includes(e.key))) e.preventDefault();
        });
    </script>

    <style>
        :root {
            --bg-gradient: radial-gradient(circle at center, #333333 0%, #050505 100%);
            --card-bg: #111111;
            --gold: #d4af37;
            --blue: #00d2ff;
            --red: #ff416c;
            --success: #00ff88;
            --text: #ffffff;
            --text-muted: #aaaaaa;
            --input-bg: #1a1a1a;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0; background: #1a1a1a; color: var(--text);
            min-height: 100vh; display: flex; justify-content: center; align-items: flex-start;
            padding: 20px 0; -webkit-tap-highlight-color: transparent;
        }

        .bg-glow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-gradient); z-index: -1; }

        .container {
            width: 95%; max-width: 1100px; background: var(--card-bg);
            border-radius: 40px; border: 2px solid rgba(212, 175, 55, 0.3);
            padding: 40px 25px 60px 25px; box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            position: relative; overflow: hidden;
        }

        .version-block {
            position: absolute; bottom: 0; left: 0;
            background: rgba(212, 175, 55, 0.2); color: var(--gold);
            padding: 5px 15px; font-size: 0.6em; font-weight: 700;
            letter-spacing: 2px; border-top-right-radius: 15px;
            border-right: 1px solid rgba(212, 175, 55, 0.3);
            border-top: 1px solid rgba(212, 175, 55, 0.3);
        }

        h1 { color: var(--gold); font-size: 1.4em; text-align: center; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        h2 { color: var(--text-muted); font-size: 0.8em; text-align: center; margin-bottom: 30px; letter-spacing: 1px; }

        .logout-btn {
            position: absolute; top: 20px; right: 25px;
            background: rgba(255, 65, 108, 0.1); border: 1px solid var(--red);
            color: var(--red); padding: 5px 15px; border-radius: 10px;
            font-size: 0.7em; cursor: pointer; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--red); color: white; }

        .tab-nav {
            display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .tab-button {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted); padding: 10px 20px; border-radius: 15px;
            cursor: pointer; font-size: 0.8em; font-weight: 600; transition: 0.3s;
        }
        .tab-button.active {
            background: var(--gold); color: black; border-color: var(--gold);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .panitia-tab-content { display: none; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-group {
            background: rgba(255,255,255,0.02); padding: 20px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 30px;
        }
        input, select {
            background: var(--input-bg); border: 1px solid #333; color: white;
            padding: 12px; border-radius: 10px; width: 100%; margin: 8px 0 15px 0;
            font-family: 'Poppins';
        }
        input:focus, select:focus { border-color: var(--gold); outline: none; }
        
        .btn-submit {
            background: var(--gold); color: black; border: none; padding: 12px;
            width: 100%; border-radius: 12px; font-weight: 700; cursor: pointer;
        }

        .search-area { margin-bottom: 15px; }
        .search-area input { margin: 0; border-radius: 15px; background: rgba(255,255,255,0.05); }

        .table-container {
            overflow-x: auto; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: rgba(255,255,255,0.03); color: var(--gold); padding: 15px; text-align: left; font-size: 0.8em; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85em; }
        tr:hover { background: rgba(212, 175, 55, 0.02); }

        .input-with-status { display: flex; align-items: center; gap: 8px; }
        .input-with-status input { width: 80px; margin: 0; padding: 5px 10px; text-align: center; }
        .save-status { font-size: 0.8em; font-weight: bold; min-width: 20px; }

        @media (max-width: 768px) {
            .container { padding: 50px 15px 60px 15px; }
            .tab-button { flex: 1; padding: 10px 5px; font-size: 0.7em; }
        }
    </style>
</head>
<body>

    <div class="bg-glow"></div>

    <div class="container">
        <div class="version-block">V 2.0</div>
        <button class="logout-btn" onclick="logout()">LOGOUT</button>

        <h1>PANITIA DASHBOARD</h1>
        <h2>Input Data Peserta & Fisik</h2>

        <div class="tab-nav">
            <button class="tab-button active" onclick="showPanitiaTab('inputPeserta')">REGISTRASI</button>
            <button class="tab-button" onclick="showPanitiaTab('inputBB')">BERAT BADAN</button>
            <button class="tab-button" onclick="showPanitiaTab('inputTB')">TINGGI BADAN</button>
        </div>

        <div id="inputPeserta" class="panitia-tab-content" style="display: block;">
            <div class="input-group">
                <h3 style="color: var(--gold); font-size: 0.9em; margin-top: 0;">PENDAFTARAN BARU</h3>
                <form id="panitiaInputForm" onsubmit="daftarPesertaHandler(event)">
                    <select id="panitiaSekolahSelect" required></select>
                    <input type="text" id="panitiaNama" placeholder="Nama Lengkap Peserta" required>
                    <select id="panitiaJenisKelamin" required>
                        <option value="">Pilih Jenis Kelamin</option>
                        <option value="Cewek">Cewek</option>
                        <option value="Cowok">Cowok</option>
                    </select>
                    <button type="submit" class="btn-submit">DAFTARKAN PESERTA</button>
                </form>
            </div>
            
            <div class="search-area">
                <input type="text" id="searchCrud" placeholder="ðŸ” Cari Nama / Kode..." onkeyup="filterTable('panitiaCrudList', 'searchCrud')">
            </div>
            <div class="table-container" id="panitiaCrudList"></div>
        </div>

        <div id="inputBB" class="panitia-tab-content">
            <div class="search-area">
                <input type="text" id="searchBB" placeholder="ðŸ” Cari Nama / Kode..." onkeyup="filterTable('panitiaBBList', 'searchBB')">
            </div>
            <div class="table-container" id="panitiaBBList"></div>
        </div>

        <div id="inputTB" class="panitia-tab-content">
            <div class="search-area">
                <input type="text" id="searchTB" placeholder="ðŸ” Cari Nama / Kode..." onkeyup="filterTable('panitiaTBList', 'searchTB')">
            </div>
            <div class="table-container" id="panitiaTBList"></div>
        </div>
    </div>

    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDpPEkKbEt6b_v2OWlBfGuaVQpBg2-RWR4",
            authDomain: "cwu-gen-2.firebaseapp.com",
            databaseURL: "https://cwu-gen-2-default-rtdb.firebaseio.com",
            projectId: "cwu-gen-2",
            storageBucket: "cwu-gen-2.appspot.com",
            messagingSenderId: "40585612014",
            appId: "1:40585612014:web:c88141fee3699aca68181ff"
        };
        firebase.initializeApp(FIREBASE_CONFIG);
        const database = firebase.database();

        const CURRENT_USER = localStorage.getItem('ppi_nama') || "Panitia";

        function checkAuth() {
            if (!localStorage.getItem('ppi_nama')) {
                 window.location.href = 'index.html';
            }
        }

        function logout() {
            window.location.href = 'index.html';
        }

        let allSekolah = {}, allPeserta = {}, allPenilaian = {}, allKetentuan = {};

        function initializeDataListeners() {
            database.ref('ketentuanLulus').on('value', s => { allKetentuan = s.val() || {}; refreshViews(); });
            database.ref('sekolah').on('value', s => { allSekolah = s.val() || {}; updateSekolahDropdowns(); refreshViews(); });
            database.ref('penilaian').on('value', s => { allPenilaian = s.val() || {}; refreshViews(); });
            database.ref('peserta').on('value', s => { allPeserta = s.val() || {}; refreshViews(); });
        }

        function refreshViews() {
            const activeTab = document.querySelector('.panitia-tab-content[style*="block"]')?.id;
            if (activeTab === 'inputPeserta') renderPanitiaCrudTable();
            if (activeTab === 'inputBB') renderPanitiaBBTable();
            if (activeTab === 'inputTB') renderPanitiaTBTable();
        }

        function showPanitiaTab(tabId) {
            document.querySelectorAll('.panitia-tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`button[onclick="showPanitiaTab('${tabId}')"]`).classList.add('active');
            refreshViews();
        }

        function updateSekolahDropdowns() {
            const sel = document.getElementById('panitiaSekolahSelect');
            if(!sel) return;
            sel.innerHTML = '<option value="">Pilih Sekolah</option>';
            Object.keys(allSekolah).forEach(k => {
                if (allSekolah[k].statusPenilaian === 'Dibuka') {
                    sel.innerHTML += `<option value="${k}">${allSekolah[k].namaSekolah}</option>`;
                }
            });
        }

        function generateRandomCode() {
            const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for(let i=0; i<4; i++) code += c.charAt(Math.floor(Math.random() * c.length));
            return code;
        }

        function getPenilaianData(id) {
            const key = Object.keys(allPenilaian).find(k => allPenilaian[k].idPeserta === id);
            return key ? { ...allPenilaian[key], idPenilaian: key } : {};
        }

        async function savePenilaian(idPeserta, field) {
            const input = document.getElementById(`${field.toLowerCase()}-input-${idPeserta}`);
            const status = document.getElementById(`status-${field.toLowerCase()}-${idPeserta}`);
            const val = parseFloat(input.value);
            if (isNaN(val)) return;

            const p = allPeserta[idPeserta];
            const exist = getPenilaianData(idPeserta);
            const now = new Date();

            status.textContent = 'â³';
            const formatHari = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            const data = {
                beratBadan: field === 'BB' ? val : (exist.beratBadan || 0),
                tinggiBadan: field === 'TB' ? val : (exist.tinggiBadan || 0),
                idPeserta: idPeserta,
                adminInput: CURRENT_USER,
                tanggal: formatHari,
                jam: now.toLocaleTimeString('id-ID', {hour12:false}),
                lastUpdate: now.toISOString()
            };

            if (data.beratBadan > 0 && data.tinggiBadan > 0) {
                const k = allKetentuan[p.jenisKelamin];
                if(k) {
                    data.hasilLulus = (data.beratBadan >= k.minBerat && data.beratBadan <= k.maxBerat && 
                                       data.tinggiBadan >= k.minTinggi && data.tinggiBadan <= k.maxTinggi);
                }
            }

            const ref = exist.idPenilaian ? database.ref('penilaian/'+exist.idPenilaian) : database.ref('penilaian').push();
            await ref.update(data);
            
            status.textContent = 'âœ”';
            status.style.color = 'var(--success)';
            setTimeout(() => { status.textContent = ''; }, 2000);
        }

        function renderPanitiaCrudTable() {
            let h = `<table><thead><tr><th>No</th><th>Kode</th><th>Nama</th><th>JK</th><th>Sekolah</th></tr></thead><tbody>`;
            // Menggunakan Object.keys tanpa .sort() agar urutan tetap sesuai database (dari atas ke bawah)
            Object.keys(allPeserta).forEach((k, i) => {
                const p = allPeserta[k];
                h += `<tr><td>${i+1}</td><td><b style="color:var(--blue)">${p.kodePeserta}</b></td><td>${p.nama}</td><td>${p.jenisKelamin || '-'}</td><td>${allSekolah[p.idSekolah]?.namaSekolah || '-'}</td></tr>`;
            });
            document.getElementById('panitiaCrudList').innerHTML = h + `</tbody></table>`;
        }

        function renderPanitiaBBTable() {
            let h = `<table><thead><tr><th>No</th><th>Kode</th><th>Nama (JK)</th><th>Berat (kg)</th></tr></thead><tbody>`;
            Object.keys(allPeserta).forEach((k, i) => {
                const p = allPeserta[k];
                const v = getPenilaianData(k).beratBadan || '';
                h += `<tr><td>${i+1}</td><td>${p.kodePeserta}</td><td>${p.nama} <small>(${p.jenisKelamin})</small></td>
                <td><div class="input-with-status"><input type="number" step="0.1" id="bb-input-${k}" value="${v}" onblur="savePenilaian('${k}','BB')"><span class="save-status" id="status-bb-${k}"></span></div></td></tr>`;
            });
            document.getElementById('panitiaBBList').innerHTML = h + `</tbody></table>`;
        }

        function renderPanitiaTBTable() {
            let h = `<table><thead><tr><th>No</th><th>Kode</th><th>Nama (JK)</th><th>Tinggi (cm)</th></tr></thead><tbody>`;
            Object.keys(allPeserta).forEach((k, i) => {
                const p = allPeserta[k];
                const v = getPenilaianData(k).tinggiBadan || '';
                h += `<tr><td>${i+1}</td><td>${p.kodePeserta}</td><td>${p.nama} <small>(${p.jenisKelamin})</small></td>
                <td><div class="input-with-status"><input type="number" step="0.1" id="tb-input-${k}" value="${v}" onblur="savePenilaian('${k}','TB')"><span class="save-status" id="status-tb-${k}"></span></div></td></tr>`;
            });
            document.getElementById('panitiaTBList').innerHTML = h + `</tbody></table>`;
        }

        function filterTable(containerId, inputId) {
            const val = document.getElementById(inputId).value.toUpperCase();
            const rows = document.getElementById(containerId).querySelectorAll('tr');
            rows.forEach((r, i) => {
                if (i === 0) return;
                r.style.display = r.innerText.toUpperCase().includes(val) ? '' : 'none';
            });
        }

        function daftarPesertaHandler(e) {
            e.preventDefault();
            const data = {
                idSekolah: document.getElementById('panitiaSekolahSelect').value,
                nama: document.getElementById('panitiaNama').value,
                jenisKelamin: document.getElementById('panitiaJenisKelamin').value,
                kodePeserta: generateRandomCode()
            };
            database.ref('peserta').push(data).then(() => {
                alert('Berhasil! Kode Peserta: ' + data.kodePeserta);
                document.getElementById('panitiaInputForm').reset();
            });
        }

        document.addEventListener('DOMContentLoaded', () => { 
            checkAuth(); 
            initializeDataListeners(); 
        });
    </script>
</body>
</html>
